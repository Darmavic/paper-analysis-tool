# 未编号公式识别方案

## 需求
即使公式没有编号，也希望按文章行文顺序识别并构建子section分析。

## 解决方案

### 已实施：扩展Architect提示词

#### 新增"未编号显示公式"要求

```
**B. 未编号显示公式（补充）**：
- 识别重要的未编号显示公式（Marker转换为 $$...$$ 格式）
- **按行文顺序**为这些公式创建section
- 根据上下文给予描述性标题
- 1-3个主题相关的未编号公式可以合并分析
```

#### 标题格式规范

**编号公式**：
```
"3.2.1 Equation 1-3: logLR计算"
```

**未编号公式**：
```
"3.2.2 贝叶斯更新公式"
"3.2.3 核心损失函数"
"4.1.3 后验概率计算"
```

## 工作流程

### 1. Marker转换
- 所有显示公式转为 `$$...$$` 格式
- 内嵌公式转为 `$...$` 格式

### 2. Architect识别
- 扫描文本中的 `$$...$$` 模式
- 按出现顺序记录
- 根据上下文判断重要性

### 3. Section创建
- 重要的未编号公式创建独立section
- 给予描述性标题（根据前后文）
- 保持行文顺序

### 4. 分组策略
- 1-3个主题相关的未编号公式可合并
- 例如："损失函数与优化目标"合并2-3个相关公式

## 示例结构

### 典型论文的公式section

```
3.2 理论推导
├─ 3.2.1 Equation 1-3: 贝叶斯更新规则 (编号公式)
├─ 3.2.2 先验分布定义 (未编号，重要)
├─ 3.2.3 Equation 4-5: 似然比计算 (编号公式)
├─ 3.2.4 边界条件约束 (未编号，补充)
└─ 3.2.5 最优决策准则 (未编号，总结)
```

### 每个equation section结构

```json
{
  "section_title": "3.2.2 先验分布定义",
  "type": "equation",
  "target_pages": [5],
  "sub_questions": [
    {
      "question": "这个先验分布的数学形式是什么？各参数代表什么含义？",
      "question_type": "what"  // 600-2000字
    },
    {
      "question": "为什么选择这种先验分布形式？其理论基础是什么？",
      "question_type": "principle"  // 600-2500字
    },
    {
      "question": "这个先验如何影响后验推断？",
      "question_type": "mechanism"
    }
  ]
}
```

## 优势

1. ✅ **完整覆盖**：不遗漏任何重要公式
2. ✅ **保持顺序**：按行文逻辑组织
3. ✅ **描述清晰**：标题反映公式用途
4. ✅ **灵活分组**：相关公式可合并

## 注意事项

### 内嵌公式不单独分析
- 内嵌公式（`$...$`）通常不创建独立section
- 它们会在相关text section的分析中涉及

### 判断重要性
- Architect会根据上下文判断
- 核心推导公式：必须分析
- 简单变换：可选
- 示例计算：可选

## 预期效果

重新分析后，公式覆盖更全面：
- ✅ 所有编号公式
- ✅ 重要的未编号显示公式
- ✅ 按行文顺序
- ✅ 描述性标题
