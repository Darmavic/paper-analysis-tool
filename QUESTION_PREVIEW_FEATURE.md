# 问题架构预览功能 - 说明文档

## ✅ 新增功能

在Architect生成完所有问题、Analyst开始分析之前，会在终端显示**完整的问题架构预览**，方便检查是否正常。

---

## 📊 预览示例

运行脚本时，在计划生成完成后，会看到以下输出：

```
计划已生成: 共 15 个部分需要分析。

================================================================================
📋 问题架构预览 (Question Architecture Preview)
================================================================================

论文标题: Evidence accumulation relates to perceptual consciousness
总结: 本文探讨了证据积累与知觉意识的关系，通过行为和神经数据验证贝叶斯决策模型...

共 15 个分析部分:
--------------------------------------------------------------------------------

📝 [1/15] 1. 核心贡献与摘要
   类型: text | 页码: [0, 1]
   包含 3 个子问题:
      1. 👁️ (phenomenon) 本文的核心发现和主要贡献是什么？
      2. 🔬 (mechanism) 这些发现如何推进我们对意识的理解？
      3. 💭 (critique) 研究设计有哪些创新之处和潜在局限？

📊 [2/15] 3.1.1 Fig 1a-c: 任务范式三条件
   类型: figure | 页码: [2, 2, 2]
   包含 4 个子问题:
      1. ❓ (what [优先]) Fig 1a-c展示了什么内容？图中各个元素（坐标轴、曲线...
      2. ⚙️ (principle [优先]) Fig 1a-c的工作原理/流程是怎样的？图中展示的机制、...
      3. 🔬 (mechanism) 该任务设计如何确保被试必须进行概率整合而非简单记忆？
      4. 💭 (critique) 如果改变形状呈现顺序，实验结果会如何变化？

📊 [3/15] 3.1.2 Fig 2: 刺激材料示例
   类型: figure | 页码: [3]
   包含 4 个子问题:
      1. ❓ (what [优先]) Fig 2展示了什么内容？图中各个元素分别代表什么含义？
      2. ⚙️ (principle [优先]) Fig 2的工作原理/流程是怎样的？
      3. 🔬 (mechanism) 这些刺激参数如何影响被试的决策过程？
      4. 💭 (critique) 这种刺激设计的优势和局限是什么？

🔢 [4/15] 3.2.1 Equation 1-3: logLR计算步骤
   类型: equation | 页码: [4, 4, 4]
   包含 4 个子问题:
      1. ❓ (what [优先]) Equation 1-3的完整数学表达式是什么？各个符号、变量...
      2. ⚙️ (principle [优先]) Equation 1-3的推导逻辑和计算原理是怎样的？这个公...
      3. 🔬 (mechanism) 这三个公式在实际计算中如何协同工作？
      4. 💭 (critique) 有哪些简化假设？是否存在替代计算方法？

🔢 [5/15] 3.2.2 贝叶斯更新公式
   类型: equation | 页码: [5]
   包含 3 个子问题:
      1. ❓ (what [优先]) 这个贝叶斯更新公式的数学形式是什么？
      2. ⚙️ (principle [优先]) 贝叶斯更新的理论基础和推导过程是什么？
      3. 🔬 (mechanism) 在实验中如何应用这个更新规则？

... (其他10个sections)

--------------------------------------------------------------------------------

📊 统计:
   - 总问题数: 58
   - 图表分析: 6 sections
   - 公式分析: 5 sections
   - 文本分析: 4 sections
   - 优先问题: 22 (是什么+原理)

================================================================================
⏸️  预览完成。按 Ctrl+C 可中止，或等待5秒后自动继续...
================================================================================

[等待5秒...]

▶️  开始执行分析...

分析师: 正在深入分析 1. 核心贡献与摘要...
  Sub-Question 1/3 (phenomenon): 本文的核心发现和主要贡献是什么？
💭 分析中... (尝试 1/3)
✅ 字数验证通过: 1245字 (目标1000-2000字)
...
```

---

## 🎯 预览内容说明

### 每个Section显示
- **标题和序号**: `[1/15] Section标题`
- **类型图标**: 
  - 📊 图表分析
  - 🔢 公式分析
  - 📝 文本分析
- **基本信息**: 类型 + 页码
- **子问题列表**:
  - 问题编号
  - 类型图标: ❓(what) ⚙️(principle) 👁️(phenomenon) 🔬(mechanism) 💭(critique)
  - 优先标记: `[优先]` 表示"是什么"或"原理"问题
  - 问题预览: 前60字符

### 统计信息
- 总问题数
- 图表/公式/文本sections数量
- 优先问题数量（是什么+原理）

### 交互控制
- **自动继续**: 等待5秒后自动开始Analyst分析
- **手动中止**: 按 `Ctrl+C` 可立即中止执行
- **用途**: 
  - 检查Architect是否正确识别了所有图表和公式
  - 验证问题类型是否合理
  - 确认优先问题是否存在
  - 评估总问题数是否合理

---

## ⚙️ 技术细节

### 实现位置
**文件**: `scripts/analyze_paper.py`  
**位置**: Line 2063-2138 (在Analyst loop之前)

### 核心逻辑
```python
# 1. 打印标题和基本信息
print("📋 问题架构预览")
print(f"论文标题: {outline.paper_title}")

# 2. 遍历所有sections
for idx, section in enumerate(outline.sections, 1):
    # 打印section信息
    print(f"[{idx}/{len(outline.sections)}] {section.section_title}")
    
    # 打印所有sub_questions
    for sq in section.sub_questions:
        print(f"  - ({sq.question_type}) {sq.question}")

# 3. 统计信息
total_questions = sum(len(s.sub_questions) for s in outline.sections)
priority_questions = sum(
    1 for s in outline.sections 
    for sq in s.sub_questions 
    if sq.question_type in ['what', 'principle']
)

# 4. 等待5秒或用户中止
time.sleep(5)
```

---

## 🎨 图标说明

### Section类型图标
- 📊 **Figure** - 图表分析section
- 🔢 **Equation** - 公式分析section
- 📝 **Text** - 文本分析section

### 问题类型图标
- ❓ **what** - 是什么类型问题
- ⚙️ **principle** - 原理类型问题
- 👁️ **phenomenon** - 现象描述问题
- 🔬 **mechanism** - 机理推导问题
- 💭 **critique** - 批判与改进问题

### 优先标记
- **[优先]** - 表示这是优先问题（是什么或原理）
- 对于figure/equation类型的section，前两个问题应该都是优先问题

---

## 🔍 检查要点

在预览中，您应该检查：

### ✅ 覆盖完整性
- [ ] 所有图表（包括子图组）都有对应section
- [ ] 所有公式（编号+未编号）都有对应section
- [ ] IMRAD结构完整（Introduction/Methods/Results/Discussion）

### ✅ 问题质量
- [ ] 每个figure/equation section都有"是什么"问题（❓ what [优先]）
- [ ] 每个figure/equation section都有"原理"问题（⚙️ principle [优先]）
- [ ] 问题数量合理（每个section 2-4个问题）

### ✅ 分组效果
- [ ] 子图被正确分组（如Fig 1a-c）
- [ ] 关联公式被正确分组（如Equation 1-3）
- [ ] 分组的section问题涵盖了所有组内元素

### ⚠️ 常见问题
- **无子问题**: 如果某个section显示"⚠️ 无子问题"，说明有问题
- **缺少优先问题**: figure/equation section应该有2个[优先]标记
- **问题过多**: 如果某个section有超过6个问题，可能太冗长

---

## 🚀 使用建议

### 第一次运行
1. 仔细查看预览
2. 检查上述要点
3. 如果有问题，按Ctrl+C中止
4. 调整参数或重新运行

### 日常使用
- 如果对Architect生成的大纲有信心，可以让它自动继续
- 如果是新类型论文，建议先检查预览

### 调试模式
- 如果总是需要中止修改，可以考虑：
  - 调整PAGES_PER_BATCH（影响批次大小）
  - 修改Architect的system_prompt
  - 调整公式/图表扫描策略

---

## 📝 示例场景

### 场景1: 发现问题需要中止
```
📊 统计:
   - 总问题数: 120  ← ⚠️ 太多了
   - 优先问题: 8    ← ⚠️ 太少了

⏸️  预览完成。按 Ctrl+C 可中止...

[用户按 Ctrl+C]

⏹️  用户中止执行
```

### 场景2: 确认无误自动继续
```
📊 统计:
   - 总问题数: 58   ← ✅ 合理
   - 优先问题: 22   ← ✅ 每个figure/equation都有2个

⏸️  预览完成。按 Ctrl+C 可中止，或等待5秒后自动继续...

[等待5秒...]

▶️  开始执行分析...
```

---

## 📌 总结

**问题架构预览功能**提供了：
✅ 完整的outline可视化  
✅ 问题类型和优先级清晰标记  
✅ 统计信息一目了然  
✅ 人工检查和自动继续的平衡  

**最佳实践**：
- 第一次运行新PDF时，仔细检查预览
- 熟悉的论文类型可以直接等待自动继续
- 发现问题立即Ctrl+C中止

---

**更新时间**: 2026-01-19 04:18  
**功能状态**: ✅ 已实现并测试
