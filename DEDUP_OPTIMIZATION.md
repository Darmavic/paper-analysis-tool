# 去重逻辑优化总结

## 改进目标
确保在批次合并和去重阶段，所有图表公式的分析都被保留。

## 主要改进

### 1. 优先级机制
去重时根据section类型设置优先级：
- **figure/equation**: 优先级 2（高）
- **text**: 优先级 1（低）

当发现相似section时：
- ✅ 优先保留 figure/equation 类型
- ✅ 如果优先级相同，保留子问题更多的（更详细）

### 2. 智能替换
不再简单地"保留第一个"，而是：
```python
if should_keep_new(existing, new):
    # 用优先级更高或更详细的section替换
    unique_sections[idx] = new
```

### 3. 图表覆盖验证
去重后自动验证：
- 对比检测到的图表数量 vs 保留的图表section数量
- 提取并比对图表编号（Fig.1, Table 2等）
- 如有遗漏，打印警告信息

## 预期输出示例

```
🔧 去重完成: 移除了10个重复section，保留24个唯一section
📊 图表覆盖验证: 检测到5个图表，生成了5个图表分析section
✅ 所有检测到的图表都有对应分析section
```

或：
```
⚠️  警告: 以下图表可能未被分析: fig.3, table1
```

## 使用方法

已自动集成到工作流，无需手动操作。去重时会自动：
1. 优先保留图表类型section
2. 验证覆盖完整性
3. 提示遗漏信息

## 测试建议

重新运行分析，检查：
1. 图表section是否都被保留
2. 是否有遗漏警告
3. 去重日志是否显示替换信息
