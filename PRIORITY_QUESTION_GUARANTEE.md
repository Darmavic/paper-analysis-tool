# 优先问题强制保障机制

## 问题

**Q: 怎样保证Architect一定生成了所有图表公式的"是什么"和"原理"分析？**

**A: 三层保障机制**

## 保障层级

### 第1层：Prompt要求（请求）
在Architect提示词中明确要求：
- 每个figure/equation section的第一个问题必须是"是什么+原理"
- 提供详细示例和检查清单

**限制**：无法100%保证LLM遵守

### 第2层：后处理验证+自动补全（强制）⭐
在去重完成后，自动执行`validate_and_fix_priority_questions()`：

1. **检查**每个figure/equation section
2. **识别**第一个问题是否包含"是什么+原理"
3. **补充**：如缺失，自动插入标准优先问题到第一位

**补充的优先问题模板**：
```
图表: "【优先】{title}展示了什么内容？图中各个元素代表什么含义？其工作原理/流程是怎样的？"
公式: "【优先】{title}的数学表达式是什么？各个符号代表什么含义？这个公式的计算原理和推导逻辑是怎样的？"
```

###  第3层：去重保护（不删除）
智能合并时，优先问题使用更严格的阈值（0.8），确保不被误删。

## 工作流程

```
Architect生成 → 批次合并 → 智能去重 → 🔧验证+补全 → 最终Outline
                                         ↑
                                   自动检查并修复
```

## 预期输出

```
✅ 优先问题验证通过: 所有figure/equation section都包含优先问题
```

或：

```
🔧 自动补充优先问题: 3.1.1 Fig 1分析
🔧 自动补充优先问题: 3.2.1 Equation 1分析
✅ 优先问题验证完成: 自动补充了2个遗漏的优先问题
```

## 保证程度

- **100%保证**：所有figure/equation section都有优先问题
- **质量保证**：自动生成的优先问题覆盖"是什么+原理"
- **位置保证**：优先问题始终在第一位

## 实现位置

- 函数：`validate_and_fix_priority_questions()`（第588行）
- 调用：main函数中去重后（第1227行）
