# 公式识别严格流程 - 测试检查清单

## 🎯 测试目标

验证公式识别流程的完整性和准确性。

---

## ✅ 功能测试清单

### 1. 公式扫描器测试

#### EquationScanner - 编号公式识别
- [ ] 识别标准编号: (1), (2), (3)
- [ ] 识别字母编号: (1a), (1b), (2a)
- [ ] 识别章节编号: (A.1), (B.2)
- [ ] 识别显式引用: "Equation 1", "Eq. 2", "式(1)"
- [ ] 编号在公式下方（最常见）
- [ ] 编号在公式右侧
- [ ] 编号在公式上方

**预期**: 所有编号公式都被正确识别，包含:
- `equation_number`: "1", "1a", "A.1" 等
- `equation_type`: "numbered"
- `description`: "Equation 1: xxx" (基于上下文)

#### EquationScanner - 未编号公式识别
- [ ] 包含 `\sum` (求和) 的公式被识别
- [ ] 包含 `\frac` (分数) 的公式被识别
- [ ] 包含 `\partial` (偏导) 的公式被识别
- [ ] 包含 `\max`, `\min` 的优化公式被识别
- [ ] 包含希腊字母的公式被识别
- [ ] 简单公式 (如 `x = 1`) 被正确排除
- [ ] 已识别为编号公式的不重复出现

**预期**: 重要的未编号公式被识别，简单公式被过滤

#### EquationScanner - 描述生成
- [ ] 包含"loss"/"损失" → 生成 "损失函数"
- [ ] 包含"update"/"更新" → 生成 "更新规则"
- [ ] 包含"posterior"/"后验" → 生成 "后验概率"
- [ ] 包含"prior"/"先验" →  生成 "先验分布"
- [ ] 无明显关键词 → 生成 "核心公式"

**预期**: 描述准确反映公式的用途

---

### 2. Architect集成测试

#### Prompt中的公式清单
运行脚本后，检查Architect的输入prompt是否包含:

```
## 已检测到的公式清单（必须全部分析）

### 编号公式
- 第X页: Equation 1: xxx
- 第Y页: Equation 2-3: xxx

### 重要的未编号公式
- 第Z页: 损失函数定义
- 第W页: 后验概率计算
```

- [ ] 公式清单在prompt中正确显示
- [ ] 编号公式和未编号公式分别列出
- [ ] 页码正确 (1-indexed)

#### Architect的输出
- [ ] Architect为每个公式创建了对应section
- [ ] Section标题格式正确:
  - 编号: "3.2.1 Equation 1: 描述"
  - 未编号: "3.2.2 描述"
- [ ] Section的 `type` 设置为 "equation"
- [ ] 每个section包含至少2个sub_questions

---

### 3. 公式覆盖验证测试

运行脚本后，检查控制台输出:

```
🔢 公式覆盖验证: 检测到X个公式，生成了Y个公式分析section
```

#### 完全覆盖场景
- [ ] X == Y 时显示: "✅ 所有检测到的公式都有对应分析section"

#### 部分缺失场景
- [ ] X > Y 时显示: "⚠️  检测到N个未分析的公式，自动补充..."
- [ ] 显示每个被补充的公式: "🔧 补充: xxx"
- [ ] 补充后的outline包含所有公式

#### 补充的section质量
- [ ] 自动补充的section有正确的标题
- [ ] `type` 为 "equation"
- [ ] 包含两个优先问题: "what" 和 "principle"
- [ ] `target_pages` 正确

---

### 4. 优先问题验证测试

对于所有 `type == "equation"` 的section:
- [ ] `sub_questions[0].question_type` == "what"
- [ ] `sub_questions[1].question_type` == "principle"
- [ ] "what" 问题包含: "数学表达式是什么？", "符号代表什么"
- [ ] "principle" 问题包含: "推导逻辑", "计算原理", "理论基础"

---

### 5. 端到端流程测试

#### 测试PDF准备
准备一个包含以下元素的测试PDF:
- 3个编号公式: (1), (2), (3)
- 2个未编号但重要的公式 (包含 \sum 或 \frac)
- 1个简单公式 (如 x = 1)，应被过滤

#### 运行脚本
```bash
python analyze_paper.py --pdf test.pdf --vault test_vault
```

#### 检查输出
```
🔢 公式扫描: 正在识别Marker输出中的所有公式...
✅ 检测到 5 个公式
   - 编号公式: 3
   - 重要未编号公式: 2
```
- [ ] 编号公式数量正确: 3
- [ ] 未编号公式数量正确: 2 (简单公式被过滤)

```
🔢 公式覆盖验证: 检测到5个公式，生成了5个公式分析section
✅ 所有检测到的公式都有对应分析section
```
- [ ] 生成的section数量 == 5
- [ ] 无缺失（或缺失被自动补充）

#### 检查生成的Obsidian文件
打开 `test_vault/test_paper/00_Master_Index.md`:
- [ ] 包含5个公式相关的链接
- [ ] 标题格式正确
- [ ] 每个链接对应一个独立的markdown文件

打开每个公式的markdown文件 (如 `test_paper_eq1_xxx.md`):
- [ ] 包含至少2个sub-question
- [ ] 第1个问题是"是什么" (what)
- [ ] 第2个问题是"原理" (principle)

---

### 6. 边界情况测试

#### 无公式的PDF
- [ ] 显示: "✅ 未检测到公式，跳过公式覆盖验证"
- [ ] 不报错，正常继续

#### PyMuPDF模式 (不支持公式)
设置 `USE_MARKER = False`
- [ ] 显示: "ℹ️  公式扫描: PyMuPDF模式不支持公式识别，跳过公式扫描"
- [ ] equations_list 为空
- [ ] 不影响图表分析

#### 只有未编号公式的PDF
- [ ] "编号公式" 部分显示: "- (未检测到编号公式)"
- [ ] 未编号公式正常识别

#### 只有编号公式的PDF
- [ ] "重要的未编号公式" 部分显示: "- (未检测到重要未编号公式)"
- [ ] 编号公式正常识别

---

## 🐛 常见问题排查

### 问题1: 公式被识别但Architect未创建section
**可能原因**:
- Architect的API调用失败
- Architect忽略了prompt中的公式清单

**检查**:
- 查看控制台是否有API错误
- 检查 `validate_equation_coverage` 是否自动补充了缺失section

### 问题2: 简单公式被误识别为重要公式
**可能原因**:
- `_is_important_equation` 的阈值过低

**解决**:
- 调整长度阈值 (当前20字符)
- 优化关键符号列表

### 问题3: 编号公式未被识别
**可能原因**:
- 编号格式不标准
- 编号与公式距离过远

**解决**:
- 扩大搜索范围 (当前前后3行)
- 添加更多编号模式

### 问题4: 描述生成不准确
**可能原因**:
- 上下文缺少关键词

**解决**:
- 扩展 `keyword_templates` 列表
- 增加上下文窗口 (当前前后150字符)

---

## 📊 测试结果模板

### 测试环境
- Python版本: ___
- Marker版本: ___
- 测试PDF: ___
- 日期: ___

### 测试结果摘要
| 测试项 | 结果 | 备注 |
|-------|------|------|
| 编号公式识别 | ✅/❌ | |
| 未编号公式识别 | ✅/❌ | |
| 描述生成 | ✅/❌ | |
| Architect集成 | ✅/❌ | |
| 公式覆盖验证 | ✅/❌ | |
| 优先问题验证 | ✅/❌ | |
| 端到端流程 | ✅/❌ | |

### 发现的问题
1. 
2. 
3. 

### 建议改进
1. 
2. 
3. 

---

## 🚀 快速测试命令

```bash
# 1. 测试公式扫描器（单元测试）
python -c "
from analyze_paper import EquationScanner
test_text = ['$$E = mc^2$$ (1)', '$$F = ma$$']
scanner = EquationScanner(test_text)
eqs = scanner.scan_all_equations()
print(f'检测到{len(eqs)}个公式')
for eq in eqs:
    print(f'{eq[\"equation_type\"]}: {eq[\"description\"]}')
"

# 2. 完整流程测试
python analyze_paper.py --pdf test.pdf --vault test_vault

# 3. 查看生成的outline（手动检查）
ls test_vault/test_paper/*.md
```

---

## ✅ 验收标准

**本功能被认为完成当且仅当**:
1. ✅ 所有"功能测试清单"项目通过
2. ✅ 至少一个真实论文PDF的端到端测试成功
3. ✅ 公式覆盖率 == 100% (扫描到的公式全部被分析)
4. ✅ 所有公式section都有"是什么+原理"优先问题
5. ✅ 控制台输出清晰易懂，用户可理解进度

---

**测试负责人**: ___  
**测试日期**: ___  
**测试结果**: 通过 ✅ / 失败 ❌
